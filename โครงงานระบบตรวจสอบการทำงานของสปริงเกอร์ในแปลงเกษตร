//******************************************************************************
#include <ESP8266WiFi.h>         //เรียกใช้ Library ของบอร์ด NodeMCU ESP8266
#include <BlynkSimpleEsp8266.h>  //เรียกใช้ Library ของ Blynk เพื่อใช้งานร่วมกับบอร์ด
#define SENSOR D3                //กำหนด Pin ให้เซนเซอร์ที่ขา D3
#define LED D6                   //กำหนด Pin ให้ LED ที่ขา D6
WidgetLED LED_onBlynk(V3);       //กำหนด Pin ให้ LED ใน Blynk เพื่อแสดงผลที่ V3
//******************************************************************************
//char auth[] = "ehui5cWe3ekLcn8Kfu0_vfi6JM8813FJ";  //auth สำหรับเชื่อมต่อกับ Blynk
//char ssid[] = "TUNG";                              //ชื่อ WIFI ที่ใช้เชื่อมต่อกัน
//char pass[] = "00000000";                          //รหัสผ่าน
//******************************************************************************
long previousMillis = 0;        //กำหนดตัวแปรรับค่าการหมุนของใบพัดในรอบถัดไป = 0
volatile byte pulseCount;       //กำหนดตัวแปรรับค่าการหมุนของใบพัด
byte pulse1Sec = 0;             //กำหนดตัวแปรรับค่าใบพัดในเวลา 1 วินาที = 0
float flowRate;                 //กำหนดตัวแปรรับค่าอัตราการไหลของน้ำ
void IRAM_ATTR pulseCounter()   //สร้างฟังก์ชั่นนับค่าการหมุนของใบพัด
{
  pulseCount++;               
}
//******************************************************************************
void setup()                         //กำหนดค่าเริ่มต้น
{
  Serial.begin(115200);              //กำหนดค่า uart หรือ ความเร็วในการส่งข้อมูล = 115200
  //Blynk.begin(auth, ssid, pass);     //ตรวจสอบ auth,ssid,pass
  pinMode(SENSOR, INPUT_PULLUP);     //กำหนดให้รับค่าจากเซนเซอร์
  pinMode(LED,OUTPUT);               //กำหนดให้ส่งค่าออกทาง LED (ให้ติดหรือดับ)
  pulseCount = 0;                    //กำหนดค่าจำนวนการหมุนของใบพัดให้เริ่มต้นที่ 0
  flowRate = 0.0;                    //กำหนดให้ค่าอัตราการไหลของน้ำเริ่มต้นที่ 0
  previousMillis = 0;                //กำหนดค่าการหมุนของใบพัดในรอบถัดไปเริ่มต้นที่ 0
  attachInterrupt(digitalPinToInterrupt(SENSOR), pulseCounter, FALLING); 
}                                    //รับค่าจากเซนเซอร์,ค่าการหมุน,ค่าอนาล็อก
//******************************************************************************
void loop()                                  //สร้างลูปให้ทำงานซ้ำๆในทุกๆ 1 วินาที
{                                            // millis คือคำสั่งสำหรับนับเวลา จะเริ่มนับทีละ 0.1
  if (millis() - previousMillis > 1000) {    //เมื่อการนับครบ 1 วินาที
  pulse1Sec = pulseCount;                    //ค่าการหมุนใน 1 วิ = จำนวนการหมุนของใบพัด
  pulseCount = 0;                            //จำนวนการหมุน = 0 (เพื่อเริ่มนับใหม่ในรอบเวลา 1 วินาทีถัดไป)
  flowRate = ((1000.0 / (millis() - previousMillis)) * pulse1Sec) / 7.5; //จากสูตรหาอัตราการไหลของน้ำ Q=AV
  previousMillis = millis();                 //จดจำค่าการหมุนของรอบที่ผ่านมา 
//******************************************************************************
  Serial.print("Flow rate: ");               //ปริ้นข้อความ Flow rate
  Serial.print(int(flowRate));               //ปริ้นค่าอัตราการไหลของน้ำ
  Serial.print(" L/min");                    //ปริ้น L/min
  Serial.print("\n");                        //ขึ้นบรรทัดใหม่
  //Blynk.run();                               //สั่งให้ Blynk ทำงาน
  //Blynk.virtualWrite(V2, flowRate);          //Blynk แสดงค่าอัตราการไหลของน้ำผ่าน Widget แบบกราฟครึ่งวงกลม 
//******************************************************************************
  if(flowRate > 0.5 )                        //สร้างเงื่อนไขหากอัตราการไหลของน้ำมากกว่า 0.5 L/min
      {
        digitalWrite(LED,HIGH);              //จะทำให้ LED ติด
        LED_onBlynk.on();                    //จะทำให้ LED ใน Blynk ติด
      }
      else                                   //หากอัตราการไหลของน้ำ < 0.5 L/min
      {
        digitalWrite(LED,LOW);               //จะทำให้ LED ไม่ติด
        LED_onBlynk.off();                   //จะทำให้ LED ใน Blynk ไม่ติด
      }
  }
}
//******************************************************************************
